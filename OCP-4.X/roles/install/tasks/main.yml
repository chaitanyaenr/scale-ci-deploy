---
- name: Install dependencies
  package:
    name: "{{ item }}"
    state: latest
  with_items:
    - golang
    - gcc
    - git
    - golang-bin
    - gcc-c++
    - python-pip

- name: Install awscli
  pip:
    name: awscli

- name: create gopath dir
  file:
    path: "{{ gopath | default('/root/.go') }}"
    state: directory

- name: create .aws dir
  file:
    path: "{{ ansible_env.HOME }}/.aws"
    state: directory

- name: aws config
  template:
     src: config.j2
     dest: "{{ ansible_env.HOME }}/.aws/config"

- name: aws credentials
  template:
     src: credentials.j2
     dest: "{{ ansible_env.HOME }}/.aws/credentials"

- name: set workdir
  set_fact:
    workdir: "{{ gopath }}/src/github.com/openshift/installer"

- name: cleanup installer code if it exists
  file:
    path: "{{ workdir }}"
    state: absent

- block:
    - name: get the installer bits
      git:
        repo: 'https://github.com/openshift/installer.git'
        dest: "{{ workdir }}"
        version: "{{ openshift_install_installer_version }}"

    - name: build installer binary
      shell: cd {{ workdir }}; hack/build.sh
      environment:
        GOPATH: "{{ GOPATH }}"
  when: openshift_install_use_git_installer | default(False)

- block:
    - name: create workdir
      file:
        path: "{{ workdir }}/bin"
        state: directory

    - name: setup config to talk to registry
      template:
        src: registry_auth.j2
        dest: "{{ workdir }}/bin/config.json"

    - name: extract openshift-install binary from the payload
      shell: |
        set -o pipefail
        cd {{ workdir }}/bin
        oc adm release extract --tools {{ openshift_install_release_image_override }}
        ls *.tar.gz | xargs -I % sh -c 'tar -xvf %'
        chmod +x openshift-install
  when: not openshift_install_use_git_installer | default(False)

- name: create openshift install log dir
  file:
    path: "{{ openshift_install_log_dir }}"
    state: directory

- block:
    - name: download the image
      get_url:
        url: "{{ openshift_image_url }}"
        dest: /root/rhcos-qemu.qcow2.gz

    - name: run openshift installer on libvirt
      shell: "cd {{ workdir }}; OPENSHIFT_INSTALL_RELEASE_IMAGE_OVERRIDE={{ openshift_install_release_image_override }} _OPENSHIFT_INSTALL_RELEASE_IMAGE_OVERRIDE={{ openshift_install_release_image_override }} bin/openshift-install create cluster --log-level=debug 2>&1 | tee -a {{ openshift_install_log_dir }}/install.log"
      when: (openshift_install_release_image_override is defined) and (openshift_install_release_image_override != "")

    - name: run openshift installer on libvirt
      shell: "cd {{ workdir }}; bin/openshift-install create cluster --log-level=debug 2>&1 | tee -a {{ openshift_install_log_dir }}/install.log"
      when: (openshift_install_release_image_override is undefined) or (openshift_install_release_image_override == "")
  when: openshift_install_platform == "libvirt"

- block:
    - name: setup install-config
      template:
        src: install-config.yaml.j2
        dest: "{{ workdir }}/install-config.yaml"
    - name: ignition configs
      shell: "cd {{ workdir }}; OPENSHIFT_INSTALL_RELEASE_IMAGE_OVERRIDE={{ openshift_install_release_image_override }} _OPENSHIFT_INSTALL_RELEASE_IMAGE_OVERRIDE={{ openshift_install_release_image_override }} bin/openshift-install create ignition-configs"
      when: (openshift_install_release_image_override is defined) and (openshift_install_release_image_override != "")

    - name: ignition configs
      shell: "cd {{ workdir }}; bin/openshift-install create ignition-configs"
      when: (openshift_install_release_image_override is undefined) or (openshift_install_release_image_override == "")

    - name: set the user in ignition configs
      replace:
        path: "{{ item }}"
        regexp: "core"
        replace: "{{ openshift_install_user }}"
      with_items:
        - "{{ workdir }}/bootstrap.ign"
        - "{{ workdir }}/master.ign"
        - "{{ workdir }}/worker.ign"

    - name: run openshift installer on aws using the image override
      shell: |
        set -o pipefail
        cd {{ workdir }}
        export OPENSHIFT_INSTALL_RELEASE_IMAGE_OVERRIDE={{ openshift_install_release_image_override }}
        export _OPENSHIFT_INSTALL_RELEASE_IMAGE_OVERRIDE={{ openshift_install_release_image_override }}
        bin/openshift-install create cluster --log-level=debug
      when: (openshift_install_release_image_override is defined) and (openshift_install_release_image_override != "")

    - name: run openshift installer on aws using the default release image
      shell: |
        set -o pipefail
        cd {{ workdir }}
        bin/openshift-install create cluster --log-level=debug
      when: (openshift_install_release_image_override is undefined) or (openshift_install_release_image_override == "")

    - name: copy the install log
      copy:
        src: "{{ workdir }}/.openshift_install.log"
        dest: "{{ openshift_install_log_dir }}/openshift_install.log"
        remote_src: true

    - name: sleep for sometime for the cluster to settle
      pause:
        minutes: 3
  when: openshift_install_platform == "aws"
